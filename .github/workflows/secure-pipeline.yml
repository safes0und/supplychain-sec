name: Build, Attest and Publish

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TAG_NAME: sha-${{ github.sha }}-${{ github.run_number }}

permissions:
  id-token: write   # Критически важно для OIDC с Cosign
  contents: read    # Для checkout и доступа к коду
  packages: write   # Для публикации пакетов в GHCR
  security-events: write  # Для загрузки SARIF результатов




jobs:
  build-scan-attest:
    outputs:       
        image: ${{ steps.image.outputs.image }}
        digest: ${{ steps.image.outputs.digest }}
        tag: ${{ env.TAG_NAME }}
        registry: ${{ env.REGISTRY }}
        image-name: ${{ env.IMAGE_NAME }}
    runs-on: ubuntu-latest
    steps:
      # Шаг 1: Checkout кода с повышенной безопасностью
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      # Шаг 2: Установка инструментов безопасности
      - name: Install security tools
        run: |
          # Установка Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          
          # Установка Cosign
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 | sudo tee /usr/local/bin/cosign > /dev/null
          sudo chmod +x /usr/local/bin/cosign
          
          # Установка Semgrep
          pip install semgrep

      # Шаг 3: SAST сканирование Python кода
      - name: Run SAST (Semgrep)
        run: |
          semgrep --config=auto --error-on-findings --sarif . > semgrep-results.sarif
        continue-on-error: false

      # Шаг 4: Сканирование репозитория Trivy (vuln, config, secrets)
      - name: Run Trivy filesystem scanner
        run: |
          trivy fs . \
            --format cyclonedx \
            --output trivy-fs-report.json \
            --security-checks vuln,config,secret

      # Шаг 5: Генерация SBOM для зависимостей (ДО сборки образа)
      - name: Generate pre-build SBOM
        run: |
          trivy fs . \
            --format cyclonedx \
            --output sbom-dependencies.json

      # Шаг 6: Аутентификация в реестре (перед сборкой)
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Шаг 7: Сборка Docker-образа
      - name: Build and push image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image
        id: image
        run: |
          image_name="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "image=$image_name" >> "$GITHUB_OUTPUT"
          echo "digest=${{ steps.build.outputs.digest }}" >> "$GITHUB_OUTPUT"

      # Шаг 8: Генерация финального SBOM для образа
      - name: Generate final SBOM for image
        run: |
          trivy image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }} \
            --format cyclonedx \
            --output sbom-image.json

      # Шаг 9: Подпись Docker-образа через OIDC (безключевая подпись)
      # Cosign автоматически использует OIDC токен из GITHUB_TOKEN
      - name: Sign the container image
        run: |
          cosign sign \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }} \
            --yes

      # Шаг 10: Создание аттестаций для всех критичных артефактов
      - name: Attest SBOM
        run: |
          cosign attest \
            --type cyclonedx \
            --predicate sbom-image.json \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }} \
            --yes

      - name: Attest security scan results
        run: |
          cosign attest \
            --type application/vnd.in-toto+json \
            --predicate trivy-fs-report.json \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }} \
            --yes

      # Шаг 11: Верификация созданных подписей и аттестаций
      - name: Verify image signature
        run: |
          cosign verify \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }}

      - name: Verify attestations
        run: |
          cosign verify-attestation \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }}

      # Шаг 12: Публикация SARIF результатов в GitHub Security
      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('semgrep-results.sarif') != ''
        with:
          sarif_file: semgrep-results.sarif

      # Шаг 13: Публикация артефактов безопасности
      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-artifacts
          path: |
            semgrep-results.sarif
            trivy-fs-report.json
            sbom-dependencies.json
            sbom-image.json
          retention-days: 30

      # Шаг 14: Создание сводного отчета
      - name: Create security summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ SAST scanning completed (Semgrep)" >> $GITHUB_STEP_SUMMARY
          echo "✅ Vulnerability scan completed (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "✅ SBOM generated (CycloneDX JSON)" >> $GITHUB_STEP_SUMMARY
          echo "✅ Image signed with Cosign (OIDC)" >> $GITHUB_STEP_SUMMARY
          echo "✅ Attestations created for all artifacts" >> $GITHUB_STEP_SUMMARY
          echo "✅ SLSA Provenance generated (SLSA L3)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY

  # Отдельный job для генерации SLSA Provenance (SLSA L3)
  generate-slsa:
    needs: build-scan-attest
    permissions:
      id-token: write
      contents: read
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.build-scan-attest.outputs.image }}:${{ needs.build-scan-attest.outputs.tag }}
      digest: ${{ needs.build-scan-attest.outputs.digest }}
      registry-username: ${{ github.actor }}
      registry-password: ${{ github.token }}

  # Job для аттестации SLSA Provenance после его генерации
  attest-slsa:
    needs: [build-scan-attest, generate-slsa]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      packages: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download SLSA provenance
        uses: actions/download-artifact@v4
        with:
          name: slsa-provenance
          path: .

      - name: Install Cosign
        run: |
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 | sudo tee /usr/local/bin/cosign > /dev/null
          sudo chmod +x /usr/local/bin/cosign

      - name: Attest SLSA provenance
        env:
          REGISTRY: ${{ needs.build-scan-attest.outputs.registry }}
          IMAGE_NAME: ${{ needs.build-scan-attest.outputs.image-name }}
          TAG_NAME: ${{ needs.build-scan-attest.outputs.tag }}
        run: |
          cosign attest \
            --type slsaprovenance \
            --predicate slsa-provenance.json \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }} \
            --yes