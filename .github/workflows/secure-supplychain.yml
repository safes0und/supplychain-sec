name: Build & Attest

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TAG_NAME: ${{ github.run_number }}-sha-${{ github.sha }}

permissions:
  id-token: write   # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è OIDC —Å Cosign.
  contents: read    # –î–ª—è checkout –∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–¥—É
  packages: write   # –î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–∞–∫–µ—Ç–æ–≤ –≤ GHCR
  security-events: write  # –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ SARIF —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  actions: read     # –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ SARIF —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è telemetry)

jobs:
  build-and-attest:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.image.outputs.digest }}
      tag: ${{ env.TAG_NAME }}
      registry: ${{ env.REGISTRY }}
      image-name: ${{ env.IMAGE_NAME }}
    
    steps:
      # ============================================
      # Source Checkout & Setup
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      # ============================================
      # Install security tools
      # ============================================
      - name: Install security tools
        run: |
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Cosign
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 | sudo tee /usr/local/bin/cosign > /dev/null
          sudo chmod +x /usr/local/bin/cosign
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Semgrep –∏ in-toto (–¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ü–µ–ø–æ—á–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫)
          pip install semgrep in-toto
      # ============================================
      # in-toto Layout & Functionary Key Setup
      # ============================================
      - name: Generate in-toto functionary key
        run: |
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ link –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
          python3 - <<'PYEOF'
          import os
          from cryptography.hazmat.primitives.asymmetric import rsa
          from cryptography.hazmat.primitives import serialization
          from cryptography.hazmat.backends import default_backend
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º RSA keypair
          private_key = rsa.generate_private_key(
              public_exponent=65537,
              key_size=4096,
              backend=default_backend()
          )
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
          with open("functionary-key.pem", "wb") as f:
              f.write(private_key.private_bytes(
                  encoding=serialization.Encoding.PEM,
                  format=serialization.PrivateFormat.PKCS8,
                  encryption_algorithm=serialization.NoEncryption()
              ))
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
          public_key = private_key.public_key()
          with open("functionary-key.pub", "wb") as f:
              f.write(public_key.public_bytes(
                  encoding=serialization.Encoding.PEM,
                  format=serialization.PublicFormat.SubjectPublicKeyInfo
              ))
          PYEOF
          
          chmod 600 functionary-key.pem
          echo "Functionary key generated"
      - name: Create in-toto layout
        run: |

          # –°–æ–∑–¥–∞—ë–º layout –¥–ª—è supply chain
          python3 - <<'PYEOF'
          from in_toto.models.layout import Layout, Step
          from in_toto.models.metadata import Metablock
          from securesystemslib import *

          # –°—á–∏—Ç—ã–≤–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á functionary-key.pub –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é functionary_keyid
          functionary_key = import_rsa_publickey_from_file("functionary-key.pub")
          functionary_keyid = functionary_key["keyid"]
          
          # –°–æ–∑–¥–∞—ë–º layout —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —à–∞–≥–æ–≤
          layout = Layout()
          layout._type = "layout"
          layout.expires = "2030-12-31T23:59:59Z"
          
          # –®–∞–≥ 1: SAST —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
          step_sast = Step(name="sast-scan")
          step_sast.expected_products = [["CREATE", "semgrep-results.json"]]
          step_sast.pubkeys = [functionary_keyid]  
          
          # –®–∞–≥ 2: Trivy —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
          step_trivy = Step(name="trivy-scan")
          step_trivy.expected_products = [["CREATE", "trivy-fs-report.json"]]
          step_trivy.pubkeys = [functionary_keyid]
          
          # –®–∞–≥ 3: SBOM –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
          step_sbom = Step(name="sbom-generation")
          step_sbom.expected_products = [["CREATE", "sbom-dependencies.json"]]
          step_sbom.pubkeys = [functionary_keyid]
          
          # –®–∞–≥ 4: –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
          step_build = Step(name="docker-build")
          step_build.expected_materials = [["MATCH", "Dockerfile", "WITH", "PRODUCTS", "FROM", "sbom-generation"]]
          step_build.expected_products = [["CREATE", "sbom-image.json"]]
          step_build.pubkeys = [functionary_keyid]
          
          layout.steps = [step_sast, step_trivy, step_sbom, step_build]
          
          # Inspection –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞
          # (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ –º–µ—Ä–µ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏)
          
          # –û–±—ë—Ä—Ç—ã–≤–∞–µ–º layout –≤ Metablock –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
          metablock = Metablock(signed=layout)
          metablock.dump("supply-chain.layout")
          
          print("in-toto layout created: supply-chain.layout")
          PYEOF
      
      - name: Sign in-toto layout
        run: |
          # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º layout —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º, —á—Ç–æ–±—ã in-toto-verify –º–æ–≥ –µ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
          in-toto-sign --key functionary-key.pem --f supply-chain.layout --output supply-chain.layout

      - name: SAST scan - record start
        run: |
          in-toto-record start --step-name sast-scan --signing-key functionary-key.pem
      - name: Run SAST (Semgrep) - Python code scanning
        id: semgrep
        run: |
          semgrep --config=auto --json --json-output semgrep-results.json . || echo '{"version":"2.1.0","runs":[]}' > semgrep-results.json
        continue-on-error: true

      - name: SAST scan - record stop
        run: |
          in-toto-record stop --step-name sast-scan --signing-key functionary-key.pem --products semgrep-results.json
      - name: Trivy scan - record start
        run: |
          in-toto-record start --step-name trivy-scan --signing-key functionary-key.pem
      - name: Run Trivy filesystem scanner (vuln, config, secrets)
        id: trivy-fs
        run: |
          trivy fs . \
            --format cyclonedx \
            --output trivy-fs-report.json \
            --scanners vuln,misconfig,secret \
            --exit-code 0
      - name: Trivy scan - record stop
        run: |
          in-toto-record stop --step-name trivy-scan --signing-key functionary-key.pem --products trivy-fs-report.json
      # ============================================
      # SBOM Generation (–î–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
      # ============================================
      - name: SBOM generation - record start
        run: |
          in-toto-record start --step-name sbom-generation --signing-key functionary-key.pem --materials Dockerfile requirements.txt
      - name: Generate pre-build SBOM (dependencies)
        id: sbom-deps
        run: |
          trivy fs . \
            --format cyclonedx \
            --output sbom-dependencies.json \
            --exit-code 0
      - name: SBOM generation - record stop
        run: |
          in-toto-record stop --step-name sbom-generation --signing-key functionary-key.pem --products sbom-dependencies.json
      # ============================================
      # Build Docker Image
      # ============================================
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract image metadata
        id: image
        run: |
          image_name="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          digest="${{ steps.build.outputs.digest }}"
          echo "image=$image_name" >> "$GITHUB_OUTPUT"
          echo "image=$image_name"
          echo "digest=$digest" >> "$GITHUB_OUTPUT"
          echo "digest=$digest"
      # ============================================
      # Generate Final SBOM (–î–ª—è –æ–±—Ä–∞–∑–∞)
      # ============================================
      - name: Docker build - record start
        run: |
          in-toto-record start --step-name docker-build --signing-key functionary-key.pem --materials Dockerfile
      - name: Generate final SBOM for image
        id: sbom-image
        run: |
          trivy image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }} \
            --format cyclonedx \
            --output sbom-image.json \
            --exit-code 0
      - name: Docker build - record stop
        run: |
          in-toto-record stop --step-name docker-build --signing-key functionary-key.pem --products sbom-image.json
      # ============================================
      # Collect in-toto Link Metadata
      # ============================================
      - name: Collect in-toto link metadata
        run: |
          # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ .link —Ñ–∞–π–ª—ã, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ in-toto-run
          mkdir -p in-toto-metadata
          mv *.link in-toto-metadata/ || true
          cp supply-chain.layout in-toto-metadata/
          cp functionary-key.pub in-toto-metadata/
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —Å–æ–±—Ä–∞–ª–∏
          ls -lah in-toto-metadata/
          
          echo "in-toto link metadata collected"
      # ============================================
      # Publish
      # ============================================
    #   - name: Upload SARIF results to GitHub Security
    #     uses: github/codeql-action/upload-sarif@v4
    #     with:
    #       sarif_file: semgrep-results.sarif

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-artifacts
          path: |
            semgrep-results.json
            trivy-fs-report.json
            sbom-dependencies.json
            sbom-image.json
          retention-days: 90

      - name: Upload in-toto metadata
        uses: actions/upload-artifact@v4
        with:
          name: in-toto-metadata
          path: in-toto-metadata/
          retention-days: 90

  # ============================================
  # Generate SLSA Provenance (–û—Ç–¥–µ–ª—å–Ω—ã–π job)
  # ============================================
  generate-slsa-provenance:
    needs: build-and-attest
    permissions:
      id-token: write
      contents: read
      packages: write
      actions: read
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.build-and-attest.outputs.image }}:${{ needs.build-and-attest.outputs.tag }}
      digest: ${{ needs.build-and-attest.outputs.digest }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}
      
  collect-slsa-provenance:
    needs: [build-and-attest, generate-slsa-provenance]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      packages: write
    env:
      COSIGN_EXPERIMENTAL: "1"
      IMAGE_WITH_DIGEST: ${{ needs.build-and-attest.outputs.image }}@${{ needs.build-and-attest.outputs.digest }}
    steps:
      - name: Install Cosign
        run: |
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 | sudo tee /usr/local/bin/cosign > /dev/null
          sudo chmod +x /usr/local/bin/cosign
      - name: Log in to GHCR (read provenance)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download SLSA provenance statement
        run: |
          set -euo pipefail
          cosign download attestation "$IMAGE_WITH_DIGEST" \
            --predicate-type slsaprovenance \
            > slsa-provenance.intoto.jsonl
          if [ ! -s slsa-provenance.intoto.jsonl ]; then
            echo "SLSA provenance was not found in the registry" >&2
            exit 1
          fi
          first_line=$(head -n 1 slsa-provenance.intoto.jsonl)
          printf '%s' "$first_line" | jq -r '.payload' | base64 --decode > slsa-provenance.statement.json
          jq '.predicate' slsa-provenance.statement.json > slsa-provenance.predicate.json
      - name: Upload SLSA provenance artifact
        uses: actions/upload-artifact@v4
        with:
          name: slsa-provenance
          path: |
            slsa-provenance.intoto.jsonl
            slsa-provenance.statement.json
            slsa-provenance.predicate.json
          retention-days: 90


  # ============================================
  # Sign & Attest (–Ø–¥—Ä–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
  # ============================================
  sign-and-attest:
    needs: [build-and-attest, generate-slsa-provenance, collect-slsa-provenance]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      packages: write
    env:
      COSIGN_EXPERIMENTAL: "1"
      IMAGE_WITH_TAG: ${{ needs.build-and-attest.outputs.image }}:${{ needs.build-and-attest.outputs.tag }}
      IMAGE_WITH_DIGEST: ${{ needs.build-and-attest.outputs.image }}@${{ needs.build-and-attest.outputs.digest }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install security tools
        run: |
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 | sudo tee /usr/local/bin/cosign > /dev/null
          sudo chmod +x /usr/local/bin/cosign
          
          pip install in-toto
      - name: Log in to GHCR (Cosign publishing)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          

      - name: Download SLSA provenance artifact
        uses: actions/download-artifact@v4
        with:
          name: slsa-provenance
          path: .

      - name: Download security artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-artifacts
          path: .

      - name: Download in-toto metadata
        uses: actions/download-artifact@v4
        with:
          name: in-toto-metadata
          path: in-toto-metadata

      - name: Verify supply chain with in-toto
        run: |
          # –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –≤—Å—é —Ü–µ–ø–æ—á–∫—É –ø–æ—Å—Ç–∞–≤–æ–∫ —á–µ—Ä–µ–∑ in-toto-verify
          cd in-toto-metadata
          in-toto-verify --layout supply-chain.layout --verification-keys functionary-key.pub \
            --link-dir .
      - name: Sign container image (Cosign OIDC)
        run: |
          cosign sign \
            "${IMAGE_WITH_DIGEST}" \
            --yes
      - name: Archive downloaded provenance for traceability
        run: |
          ls -lah slsa-provenance.*
          sha256sum slsa-provenance.intoto.jsonl slsa-provenance.statement.json slsa-provenance.predicate.json
      - name: Attest final SBOM
        run: |
          cosign attest \
            --type https://cyclonedx.org/bom \
            --predicate sbom-image.json \
            "${IMAGE_WITH_DIGEST}" \
            --yes
      - name: Attest dependency SBOM
        run: |
          if [ -f sbom-dependencies.json ]; then
            cosign attest \
              --type https://cyclonedx.org/bom \
              --predicate sbom-dependencies.json \
              "${IMAGE_WITH_DIGEST}" \
              --yes
          fi
      - name: Attest SAST scan results (Semgrep)
        run: |
          if [ -f semgrep-results.json ]; then
            cosign attest \
              --type https://semgrep.dev/scan-result/v0.1 \
              --predicate semgrep-results.json \
              "${IMAGE_WITH_DIGEST}" \
              --yes
          fi
      - name: Attest Trivy scan results
        run: |
          cosign attest \
            --type https://aquasecurity.github.io/trivy/vulnerability-scan/v0.1 \
            --predicate trivy-fs-report.json \
            "${IMAGE_WITH_DIGEST}" \
            --yes
      # ============================================
      # Verify in Pipeline
      # ============================================
      - name: Verify image signature with OIDC identity
        run: |
          # Verify keyless signature with certificate identity
          cosign verify \
            --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/secure-supplychain.yml@refs/heads/main" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "${IMAGE_WITH_DIGEST}"
      - name: Verify attestations with OIDC identity
        run: |
          # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è SLSA provenance
          cosign verify-attestation \
            --type slsaprovenance \
            --certificate-identity "https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@refs/tags/v2.1.0" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "${IMAGE_WITH_DIGEST}"
          
          # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è SBOM attestation
          cosign verify-attestation \
            --type https://cyclonedx.org/bom \
            --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/secure-supplychain.yml@refs/heads/main" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "${IMAGE_WITH_DIGEST}"
          # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è Semgrep attestation
          cosign verify-attestation \
            --type https://semgrep.dev/scan-result/v0.1 \
            --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/secure-supplychain.yml@refs/heads/main" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "${IMAGE_WITH_DIGEST}"
          # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è Trivy attestation
          cosign verify-attestation \
            --type https://aquasecurity.github.io/trivy/vulnerability-scan/v0.1 \
            --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/secure-supplychain.yml@refs/heads/main" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "${IMAGE_WITH_DIGEST}"
      - name: Create security summary
        run: |
          echo "## üîí Security Supply Chain Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Security Scans Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **SAST (Semgrep)**: Python code vulnerability scanning" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy FS**: Repository scanning (vulnerabilities, misconfigurations, secrets)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-build SBOM**: Dependencies analysis (sbom-dependencies.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Final SBOM**: Complete image analysis (sbom-image.json)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó in-toto Supply Chain Metadata" >> $GITHUB_STEP_SUMMARY
          echo "- **Layout**: supply-chain.layout defines expected steps" >> $GITHUB_STEP_SUMMARY
          echo "- **Link Metadata**: Generated for sast-scan, trivy-scan, sbom-generation, docker-build" >> $GITHUB_STEP_SUMMARY
          echo "- **Verification**: ‚úÖ in-toto supply chain verification PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úçÔ∏è Signatures & Attestations" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Signature**: Signed with Cosign (keyless OIDC)" >> $GITHUB_STEP_SUMMARY
          echo "- **SLSA Provenance**: Build attestation (SLSA L3) downloaded & archived" >> $GITHUB_STEP_SUMMARY
          echo "- **SBOM Attestation**: Final & dependency SBOMs attested (CycloneDX)" >> $GITHUB_STEP_SUMMARY
          echo "- **SAST Attestation**: Semgrep results attested" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy Attestation**: Repository scan attested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Verification" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Image signature verified (with OIDC certificate identity)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ SLSA provenance verified (SLSA generator identity)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ All attestations verified with certificate identity matching this workflow" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ in-toto supply chain integrity verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì§ Published" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest**: \`${{ needs.build-and-attest.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **security-artifacts**: Scan results and SBOMs" >> $GITHUB_STEP_SUMMARY
          echo "- **slsa-provenance**: SLSA statement, predicate, and in-toto JSONL" >> $GITHUB_STEP_SUMMARY
          echo "- **in-toto-metadata**: Layout, link files, and public key" >> $GITHUB_STEP_SUMMARY