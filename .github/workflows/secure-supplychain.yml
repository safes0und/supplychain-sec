name: Build & Attest

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}  # safes0und/supplychain-sec
  TAG_NAME: ${{ github.run_number }}-sha-${{ github.sha }} 

permissions:
  id-token: write   # –¥–ª—è OIDC cosign
  contents: read    # actions/checkout@v4
  packages: write   # –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ø–∞–∫–µ—Ç–æ–≤ –≤ GHCR
  security-events: write  # –∑–∞–≥—Ä—É–∑–∫–∏ SARIF —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  actions: read     # –∑–∞–≥—Ä—É–∑–∫–∏ SARIF —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ 

jobs:
  build-and-attest:
    runs-on: ubuntu-latest
    # –æ–∂–∏–¥–∞–µ–º—ã–µ –≤—ã–≤–æ–¥—ã job'–∞
    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.image.outputs.digest }}
      tag: ${{ env.TAG_NAME }}
      registry: ${{ env.REGISTRY }}
      image-name: ${{ env.IMAGE_NAME }}
    
    steps:
      # —Å–∫–∞–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      # —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Trivy, Cosign, semgrep, in-toto
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Install Cosign
        run: |
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 | sudo tee /usr/local/bin/cosign > /dev/null
          sudo chmod +x /usr/local/bin/cosign

      - name: Install semgrep and in-toto (python)
        run: |
          pip install semgrep in-toto

      # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä—ã –∫–ª—é—á–µ–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å in-toto
      - name: Generate in-toto functionary key
        run: |
          python3 - <<'PYEOF'
          import os
          from cryptography.hazmat.primitives.asymmetric import rsa
          from cryptography.hazmat.primitives import serialization
          from cryptography.hazmat.backends import default_backend
          
          # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ .pem rsa-–∫–ª—é—á–∞
          private_key = rsa.generate_private_key(
              public_exponent=65537,
              key_size=4096,
              backend=default_backend()
          )
          
          # —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
          with open("functionary-key.pem", "wb") as f:
              f.write(private_key.private_bytes(
                  encoding=serialization.Encoding.PEM,
                  format=serialization.PrivateFormat.PKCS8,
                  encryption_algorithm=serialization.NoEncryption()
              ))
          
          # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞
          public_key = private_key.public_key()

          with open("functionary-key.pub", "wb") as f:
              f.write(public_key.public_bytes(
                  encoding=serialization.Encoding.PEM,
                  format=serialization.PublicFormat.SubjectPublicKeyInfo
              ))
          PYEOF
          
          chmod 600 functionary-key.pem
          echo "Functionary key generated"
          
      # —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ .layout –¥–ª—è in-toto
      - name: Create in-toto layout
        run: |
          python3 - <<'PYEOF'
          from in_toto.models.layout import Layout, Step
          from in_toto.models.metadata import Metablock


          layout = Layout()
          layout._type = "layout"
          layout.expires = "2030-12-31T23:59:59Z"

          # –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è step'–æ–≤ layout'–∞ —Å —Ñ–∞–π–ª–∞–º–∏ .link
          functionary_keys = layout.add_functionary_keys_from_paths(["functionary-key.pub"])
          functionary_keyid = list(functionary_keys.keys())
          
          # –æ–ø–∏—Å–∞–Ω–∏—è step'–æ–≤ –¥–ª—è layout —Ñ–∞–π–ª–∞
          step_sast = Step(name="sast-scan")
          step_sast.expected_products = [["CREATE", "semgrep-results.json"]]
          step_sast.pubkeys = functionary_keyid  
          
          step_trivy = Step(name="trivy-scan")
          step_trivy.expected_products = [["CREATE", "trivy-fs-report.json"]]
          step_trivy.pubkeys = functionary_keyid
          
          step_sbom = Step(name="sbom-generation")
          step_sbom.expected_products = [["CREATE", "sbom-dependencies.json"]]
          step_sbom.pubkeys = functionary_keyid
          
          step_docker = Step(name="docker-sbom")
          step_docker.expected_materials = [["MATCH", "Dockerfile", "WITH", "PRODUCTS", "FROM", "sbom-generation"]]
          step_docker.expected_products = [["CREATE", "sbom-image.json"]]
          step_docker.pubkeys = functionary_keyid
          
          # –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ step'–æ–≤ –¥–ª—è layout —Ñ–∞–π–ª–∞
          layout.steps = [step_sast, step_trivy, step_sbom, step_docker]
          
          # –û–±—ë—Ä—Ç—ã–≤–∞–µ–º layout –≤ Metablock –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
          metablock = Metablock(signed=layout)
          metablock.dump("supply-chain.layout")
          
          print("in-toto layout created: supply-chain.layout")
          PYEOF

      
      # –ø–æ–¥–ø–∏—Å—å in-toto-sign –¥–ª—è layout'–∞ 
      - name: in-toto-sign layout
        run: |
          # –ø–æ–¥–ø–∏—Å—å layout –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –∫–ª—é—á–æ–º
          in-toto-sign --key functionary-key.pem --f supply-chain.layout --output supply-chain.layout

      # SAST –¥–ª—è python –≤ —Ñ–æ—Ä–º–∞—Ç–µ sarif –¥–ª—è GitHub Security (–±–µ–∑ in-toto)
      - name: Run Semgrep SAST in sarif
        id: semgrep_sarif
        run: |
          semgrep --config=auto --sarif --output semgrep-results.sarif . || echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[]}' > semgrep-results.sarif
        continue-on-error: true

      # –∑–∞–≥—Ä—É–∑–∫–∞ semgrep-results –≤ GitHub Security
      - name: Upload SARIF results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep-results.sarif



      # –Ω–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ in-toto step'–∞ sast-scan
      - name: SAST scan - record start
        run: |
          in-toto-record start --step-name sast-scan --signing-key functionary-key.pem
          
      # SAST –¥–ª—è python –≤ —Ñ–æ—Ä–º–∞—Ç–µ json (—Å in-toto)
      - name: Run Semgrep SAST in json 
        id: semgrep
        run: |
          semgrep --config=auto --json --json-output semgrep-results.json . || echo '{"version":"2.1.0","runs":[]}' > semgrep-results.json
        continue-on-error: true

      # –∫–æ–Ω–µ—Ü –∑–∞–ø–∏—Å–∏ in-toto step'–∞ sast-scan    
      - name: SAST scan - record stop
        run: |
          in-toto-record stop --step-name sast-scan --signing-key functionary-key.pem --products semgrep-results.json



      # –Ω–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ in-toto step'–∞ trivy-scan
      - name: Trivy scan - record start
        run: |
          in-toto-record start --step-name trivy-scan --signing-key functionary-key.pem

      # —Å–∫–∞–Ω –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Trivy fs
      - name: Trivy dependencies scan (vuln, config, secrets)
        id: trivy-fs
        run: |
          trivy fs . \
            --format cyclonedx \
            --output trivy-fs-report.json \
            --scanners vuln,misconfig,secret \
            --exit-code 0

      # –∫–æ–Ω–µ—Ü –∑–∞–ø–∏—Å–∏ in-toto step'–∞ trivy-scan
      - name: Trivy scan - record stop
        run: |
          in-toto-record stop --step-name trivy-scan --signing-key functionary-key.pem --products trivy-fs-report.json


      # –Ω–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ in-toto step'–∞ sbom-generation
      - name: SBOM-deps generation - record start
        run: |
          in-toto-record start --step-name sbom-generation --signing-key functionary-key.pem --materials Dockerfile requirements.txt

      # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SBOM —á–µ—Ä–µ–∑ Trivy 
      - name: Generate dependencies SBOM 
        id: sbom-deps
        run: |
          trivy repo . \
            --format cyclonedx \
            --output sbom-dependencies.json \
            --list-all-pkgs

      # –∫–æ–Ω–µ—Ü –∑–∞–ø–∏—Å–∏ in-toto step'–∞ sbom-generation
      - name: SBOM-deps generation - record stop
        run: |
          in-toto-record stop --step-name sbom-generation --signing-key functionary-key.pem --products sbom-dependencies.json

      # –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ GHCR
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # —É—Å—Ç–∞–Ω–æ–≤–∫–∞ buildx –¥–ª—è build-push-action
      - name: Set up Docker Buildx 
        uses: docker/setup-buildx-action@v3

      # –±–∏–ª–¥ –æ–±—Ä–∞–∑–∞ –∏ –ø—É—à –µ–≥–æ –≤ GHCR
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # –≤—ã–≤–æ–¥ –∏–º–µ–Ω–∏ –∏ —Ö–µ—à–∞ –æ–±—Ä–∞–∑–∞
      - name: Extract image metadata
        id: image
        run: |
          image_name="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          digest="${{ steps.build.outputs.digest }}"
          echo "image=$image_name" >> "$GITHUB_OUTPUT"
          echo "image=$image_name"
          echo "digest=$digest" >> "$GITHUB_OUTPUT"
          echo "digest=$digest"


      # –Ω–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ in-toto step'–∞ docker-sbom
      - name: Docker build - record start
        run: |
          in-toto-record start --step-name docker-sbom --signing-key functionary-key.pem --materials Dockerfile

      # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SBOM –¥–ª—è –æ–±—Ä–∞–∑–∞
      - name: Generate final SBOM for image
        id: sbom-image
        run: |
          trivy image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }} \
            --format cyclonedx \
            --output sbom-image.json \
            --exit-code 0

      # –∫–æ–Ω–µ—Ü –∑–∞–ø–∏—Å–∏ in-toto step'–∞ docker-sbom            
      - name: Docker build - record stop
        run: |
          in-toto-record stop --step-name docker-sbom --signing-key functionary-key.pem --products sbom-image.json

      # —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ .link —Ñ–∞–π–ª—ã, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ in-toto-run
      - name: Collect in-toto link files
        run: |
          mkdir -p in-toto-metadata
          mv *.link in-toto-metadata/ || true
          cp supply-chain.layout in-toto-metadata/
          cp functionary-key.pub in-toto-metadata/
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —Å–æ–±—Ä–∞–ª–∏
          ls -lah in-toto-metadata/
          
          echo "in-toto link metadata collected"
          
      # –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫–∞–Ω–æ–≤ –∏ SBOM –≤ artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-artifacts
          path: |
            semgrep-results.json
            trivy-fs-report.json
            sbom-dependencies.json
            sbom-image.json
          retention-days: 90

      # –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ in-toto –≤ artifacts
      - name: Upload in-toto metadata
        uses: actions/upload-artifact@v4
        with:
          name: in-toto-metadata
          path: in-toto-metadata/
          retention-days: 90



  # –æ—Ç–¥–µ–ª—å–Ω—ã–π job –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SLSA provenance
  generate-slsa-provenance:
    needs: build-and-attest
    permissions:
      id-token: write
      contents: read
      packages: write
      actions: read
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.build-and-attest.outputs.image }}:${{ needs.build-and-attest.outputs.tag }}
      digest: ${{ needs.build-and-attest.outputs.digest }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  # —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ –≤—ã–≥—Ä—É–∑–∫–∞ SLSA provenance –≤ artifacts
  collect-slsa-provenance:
    needs: [build-and-attest, generate-slsa-provenance]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      packages: write
    env:
      COSIGN_EXPERIMENTAL: "1"
      IMAGE_WITH_DIGEST: ${{ needs.build-and-attest.outputs.image }}@${{ needs.build-and-attest.outputs.digest }}
    steps:

      # —É—Å—Ç–∞–Ω–æ–≤–∫–∞ cosign –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è slsa provenance
      - name: Install Cosign
        run: |
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 | sudo tee /usr/local/bin/cosign > /dev/null
          sudo chmod +x /usr/local/bin/cosign

      # –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ GHCR
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ SLSA provenance –∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ statement + predicate
      - name: Download SLSA provenance
        run: |
          set -euo pipefail
          cosign download attestation "$IMAGE_WITH_DIGEST" \
            --predicate-type slsaprovenance \
            > slsa-provenance.intoto.jsonl
          if [ ! -s slsa-provenance.intoto.jsonl ]; then
            echo "SLSA provenance was not found in the registry" >&2
            exit 1
          fi
          first_line=$(head -n 1 slsa-provenance.intoto.jsonl)
          printf '%s' "$first_line" | jq -r '.payload' | base64 --decode > slsa-provenance.statement.json
          jq '.predicate' slsa-provenance.statement.json > slsa-provenance.predicate.json
          
      # –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ SLSA –≤ artifacts
      - name: Upload SLSA provenance artifact
        uses: actions/upload-artifact@v4
        with:
          name: slsa-provenance
          path: |
            slsa-provenance.intoto.jsonl
            slsa-provenance.statement.json
            slsa-provenance.predicate.json
          retention-days: 90

  # –ø–æ–¥–ø–∏—Å—å –∏ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  sign-and-attest:
    needs: [build-and-attest, generate-slsa-provenance, collect-slsa-provenance]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      packages: write
    env:
      COSIGN_EXPERIMENTAL: "1"
      IMAGE_WITH_TAG: ${{ needs.build-and-attest.outputs.image }}:${{ needs.build-and-attest.outputs.tag }}
      IMAGE_WITH_DIGEST: ${{ needs.build-and-attest.outputs.image }}@${{ needs.build-and-attest.outputs.digest }}
    steps:

      # —Å–∫–∞–Ω —Ä–∞–ø–æ–∑–∏—Ç–æ—Ä–∏—è 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # —É—Å—Ç–∞–Ω–æ–≤–∫–∞ cosign –∏ in-tot
      - name: Install cosign
        run: |
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 | sudo tee /usr/local/bin/cosign > /dev/null
          sudo chmod +x /usr/local/bin/cosign
          
          pip install in-toto

      # –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ GHCR
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          

      # —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ —Å SLSA
      - name: Download SLSA provenance artifact
        uses: actions/download-artifact@v4
        with:
          name: slsa-provenance
          path: .

      - name: Checkout slsa-provenance origin
        run: |
          ls -lah slsa-provenance.*
          sha256sum slsa-provenance.intoto.jsonl slsa-provenance.statement.json slsa-provenance.predicate.json

      # —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫–∞–Ω–æ–≤ –∏ SBOM 
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-artifacts
          path: .

      # —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ in-toto
      - name: Download in-toto artifacts
        uses: actions/download-artifact@v4
        with:
          name: in-toto-metadata
          path: in-toto-metadata

      # keyless –ø–æ–¥–ø–∏—Å—å –æ–±—Ä–∞–∑–∞ 
      - name: Sign docker image 
        run: |
          COSIGN_EXPERIMENTAL=1 \
          cosign sign \
            "${IMAGE_WITH_DIGEST}" \
            --yes

      # –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è SBOM –æ–±—Ä–∞–∑–∞
      - name: Attest image SBOM
        run: |
          if [ -f sbom-image.json ]; then
          cosign attest \
            --type https://cyclonedx.org/bom \
            --predicate sbom-image.json \
            "${IMAGE_WITH_DIGEST}" \
            --yes
          fi   

      # –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è SBOM –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Attest dependency SBOM
        run: |
          if [ -f sbom-dependencies.json ]; then
            cosign attest \
              --type https://cyclonedx.org/bom \
              --predicate sbom-dependencies.json \
              "${IMAGE_WITH_DIGEST}" \
              --yes
          fi

      # –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ semgrep         
      - name: Attest semgrep SAST results
        run: |
          if [ -f semgrep-results.json ]; then
            cosign attest \
              --type https://semgrep.dev/scan-result/v0.1 \
              --predicate semgrep-results.json \
              "${IMAGE_WITH_DIGEST}" \
              --yes
          fi
          
      # –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫–∞–Ω–∞ Trivy
      - name: Attest Trivy fs scan results
        run: |
          cosign attest \
            --type https://aquasecurity.github.io/trivy/vulnerability-scan/v0.1 \
            --predicate trivy-fs-report.json \
            "${IMAGE_WITH_DIGEST}" \
            --yes
      
      # –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –í–°–ï–• –≠–¢–ê–ü–û–í, –ß–¢–û –í–°–ï –ü–†–û–®–õ–û –£–°–ü–ï–®–ù–û –ò –ü–û–î–ü–ò–°–ê–ù–û
      # –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ü–µ–ø–æ—á–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫ —á–µ—Ä–µ–∑ in-toto-verify
      - name: Verify in-toto chain 
        run: |
          cd in-toto-metadata
          in-toto-verify --layout supply-chain.layout --verification-keys functionary-key.pub \
          --link-dir .

      # –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–∑–∞ docker
      - name: Verify docker image
        run: |
          COSIGN_EXPERIMENTAL=1 \
          cosign verify \
            --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/secure-supplychain.yml@refs/heads/main" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "${IMAGE_WITH_DIGEST}"
            
      # –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è SLSA provenance
      - name: Verify SLSA provenance
        run: |
            # COSIGN_EXPERIMENTAL=1 \
            # cosign verify-attestation \
            #   --type https://slsa.dev/provenance/v0.2 \
            #   --certificate-identity 'https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@refs/tags/v2.1.0' \
            #   --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            #   "${IMAGE_WITH_DIGEST}"

      # –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∞—Ç—Ç–µ—Å—Ç–∞—Ç–æ–≤             
      - name: Verify semgrep, trivy, sbom
        run: |
          # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è SBOM attestation
          COSIGN_EXPERIMENTAL=1 \
          cosign verify-attestation \
            --type https://cyclonedx.org/bom \
            --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/secure-supplychain.yml@refs/heads/main" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "${IMAGE_WITH_DIGEST}"

          # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è Semgrep attestation
          COSIGN_EXPERIMENTAL=1 \
          cosign verify-attestation \
            --type https://semgrep.dev/scan-result/v0.1 \
            --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/secure-supplychain.yml@refs/heads/main" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "${IMAGE_WITH_DIGEST}"

          # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è Trivy attestation
          COSIGN_EXPERIMENTAL=1 \
          cosign verify-attestation \
            --type https://aquasecurity.github.io/trivy/vulnerability-scan/v0.1 \
            --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/secure-supplychain.yml@refs/heads/main" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "${IMAGE_WITH_DIGEST}"

      # –≤—ã–≤–æ–¥ —Å–∞–º–º–∞—Ä–∏ –ø–æ –ø–∞–π–ø–ª–∞–π–Ω—É
      - name: Create summary
        run: |
          echo "## üîí Security Supply Chain Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Security Scans Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **SAST (Semgrep)**: Python code vulnerability scanning" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy FS**: Repository scanning (vulnerabilities, misconfigurations, secrets)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-build SBOM**: Dependencies analysis (sbom-dependencies.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Final SBOM**: Complete image analysis (sbom-image.json)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó in-toto Supply Chain Metadata" >> $GITHUB_STEP_SUMMARY
          echo "- **Layout**: supply-chain.layout defines expected steps" >> $GITHUB_STEP_SUMMARY
          echo "- **Link Metadata**: Generated for sast-scan, trivy-scan, sbom-generation, docker-sbom" >> $GITHUB_STEP_SUMMARY
          echo "- **Verification**: ‚úÖ in-toto supply chain verification PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úçÔ∏è Signatures & Attestations" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Signature**: Signed with Cosign (keyless OIDC)" >> $GITHUB_STEP_SUMMARY
          echo "- **SLSA Provenance**: Build attestation (SLSA L3) downloaded & archived" >> $GITHUB_STEP_SUMMARY
          echo "- **SBOM Attestation**: Final & dependency SBOMs attested (CycloneDX)" >> $GITHUB_STEP_SUMMARY
          echo "- **SAST Attestation**: Semgrep results attested" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy Attestation**: Repository scan attested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Verification" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Image signature verified (with OIDC certificate identity)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ SLSA provenance verified (SLSA generator identity)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ All attestations verified with certificate identity matching this workflow" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ in-toto supply chain integrity verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì§ Published" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest**: \`${{ needs.build-and-attest.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **security-artifacts**: Scan results and SBOMs" >> $GITHUB_STEP_SUMMARY
          echo "- **slsa-provenance**: SLSA statement, predicate, and in-toto JSONL" >> $GITHUB_STEP_SUMMARY
          echo "- **in-toto-metadata**: Layout, link files, and public key" >> $GITHUB_STEP_SUMMARY

  # –¥–µ–ø–ª–æ–π –≤ –¥–æ–∫–µ—Ä 
  deploy-to-self-hosted:
    needs: [sign-and-attest, build-and-attest]
    runs-on: [self-hosted, linux]
    permissions:
      contents: read
      packages: read
    env:
      IMAGE: ${{ needs.build-and-attest.outputs.image }}
      TAG: ${{ needs.build-and-attest.outputs.tag }}
      CONTAINER_NAME: supplychain-sec
    steps:

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Pull image
        run: |
          docker pull "${IMAGE}:${TAG}"

      - name: Stop existing container
        run: |
          docker rm -f "${CONTAINER_NAME}" || true

      - name: Run updated container
        run: |
          docker run -d \
            --name "${CONTAINER_NAME}" \
            --restart unless-stopped \
            -p 7777:7777 \
            "${IMAGE}:${TAG}"